name: Deploy to Fabric Production

on:
  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'Reason for production deployment'
        required: true
        type: string
      approval_ticket:
        description: 'Change Management Ticket Number'
        required: true
        type: string
  push:
    tags:
      - 'v*.*.*'  # Production release tags (e.g., v1.2.3)

env:
  FABRIC_WORKSPACE_NAME: 'NVR-Prod1'
  ENVIRONMENT: 'prod'

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîç Validate Release Tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Release Tag: $TAG_NAME"
          
          # Validate semantic versioning
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid tag format. Must be vX.Y.Z (e.g., v1.2.3)"
            exit 1
          fi
          echo "‚úÖ Valid release tag format"
      
      - name: üìã Check Change Management Ticket
        if: github.event.inputs.approval_ticket
        run: |
          TICKET="${{ github.event.inputs.approval_ticket }}"
          echo "üé´ Change Management Ticket: $TICKET"
          
          # Add validation logic for your ticketing system here
          # For now, just validate format (e.g., CHG-12345)
          if [[ ! $TICKET =~ ^CHG-[0-9]+$ ]]; then
            echo "‚ö†Ô∏è Warning: Ticket format doesn't match CHG-##### pattern"
          fi
          echo "‚úÖ Ticket number recorded"
  
  deploy:
    name: Deploy to Production
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests azure-identity pyyaml pandas jupyter nbformat
          echo "‚úÖ Dependencies installed"
      
      - name: üîê Authenticate to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'
      
      - name: üé´ Get Fabric Access Token
        id: get_token
        run: |
          TOKEN=$(az account get-access-token --resource https://analysis.windows.net/powerbi/api --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "FABRIC_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "‚úÖ Fabric token acquired"
      
      - name: üì∏ Backup Production Workspace
        id: backup
        run: |
          echo "üì∏ Creating backup of current Production state..."
          BACKUP_ID="backup-prod-$(date +%Y%m%d-%H%M%S)"
          
          python scripts/backup_workspace.py \
            --workspace-id "${{ secrets.FABRIC_PROD_WORKSPACE_ID }}" \
            --backup-id "$BACKUP_ID" \
            --output-path "backups/"
          
          echo "backup_id=$BACKUP_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Backup completed: $BACKUP_ID"
      
      - name: üöÄ Deploy to Production
        run: |
          echo "üöÄ Deploying to Production workspace..."
          python scripts/deploy_to_fabric.py \
            --workspace-id "${{ secrets.FABRIC_PROD_WORKSPACE_ID }}" \
            --environment prod \
            --artifact-type all \
            --artifacts-path . \
            --validate-before-deploy
          echo "‚úÖ Production deployment completed"
      
      - name: üß™ Run Smoke Tests
        run: |
          echo "üß™ Running production smoke tests..."
          python scripts/run_smoke_tests.py \
            --workspace-id "${{ secrets.FABRIC_PROD_WORKSPACE_ID }}" \
            --environment prod
          echo "‚úÖ Smoke tests passed"
      
      - name: ‚úÖ Validate Production Deployment
        run: |
          echo "üîç Validating Production deployment..."
          python scripts/validate_deployment.py \
            --workspace-id "${{ secrets.FABRIC_PROD_WORKSPACE_ID }}" \
            --environment prod \
            --strict-mode
          echo "‚úÖ Production validation passed"
      
      - name: üìä Generate Deployment Report
        if: always()
        run: |
          echo "## üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workspace | \`${{ env.FABRIC_WORKSPACE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Change Ticket | ${{ github.event.inputs.approval_ticket || 'Tag-triggered' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reason | ${{ github.event.inputs.deployment_reason || 'Scheduled release' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backup | ‚úÖ Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Notebooks | ‚úÖ Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipelines | ‚úÖ Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üéâ Production deployment successful!**" >> $GITHUB_STEP_SUMMARY
      
      - name: üìß Send Deployment Notification
        if: success()
        run: |
          echo "üìß Sending deployment notification..."
          # Add your notification logic here (Slack, Teams, Email, etc.)
          echo "‚úÖ Notification sent"
      
      - name: üîô Rollback on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed - initiating rollback..."
          python scripts/rollback_deployment.py \
            --workspace-id "${{ secrets.FABRIC_PROD_WORKSPACE_ID }}" \
            --backup-path "backups/${{ steps.backup.outputs.backup_id }}" || echo "‚ö†Ô∏è Rollback failed or not configured"
          echo "‚úÖ Rollback completed"
      
      - name: üì¢ Create Deployment Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® URGENT: Production Deployment Failed',
              body: `Production deployment has failed and rollback was initiated.\n\n**Workflow:** ${context.workflow}\n**Run:** ${context.runNumber}\n**Commit:** ${context.sha}\n**Triggered By:** ${context.actor}\n**Change Ticket:** ${{ github.event.inputs.approval_ticket }}\n\n‚ö†Ô∏è **IMMEDIATE ACTION REQUIRED**\n\nPlease check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) immediately.`,
              labels: ['production', 'critical', 'deployment'],
              assignees: ['${{ github.actor }}']
            })
