name: Deploy to Fabric Test

on:
  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'Reason for deployment'
        required: true
        type: string
  push:
    tags:
      - 'v*.*.*-rc*'  # Release candidate tags

env:
  FABRIC_WORKSPACE_NAME: 'NVR-Test'
  ENVIRONMENT: 'test'

jobs:
  deploy:
    name: Deploy to Test Workspace
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests azure-identity pyyaml pandas jupyter nbformat
          echo "âœ… Dependencies installed"
      
      - name: ðŸ” Authenticate to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'
      
      - name: ðŸŽ« Get Fabric Access Token
        id: get_token
        run: |
          TOKEN=$(az account get-access-token --resource https://analysis.windows.net/powerbi/api --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "FABRIC_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "âœ… Fabric token acquired"
      
      - name: ðŸš€ Deploy All Artifacts to Test
        run: |
          echo "ðŸš€ Deploying all artifacts to Test workspace..."
          python scripts/deploy_to_fabric.py \
            --workspace-id "${{ secrets.FABRIC_TEST_WORKSPACE_ID }}" \
            --environment test \
            --artifact-type all \
            --artifacts-path .
          echo "âœ… Artifacts deployed successfully"
      
      - name: ðŸ§ª Run Integration Tests
        run: |
          echo "ðŸ§ª Running integration tests in Test workspace..."
          python scripts/run_integration_tests.py \
            --workspace-id "${{ secrets.FABRIC_TEST_WORKSPACE_ID }}" \
            --environment test
          echo "âœ… Integration tests passed"
      
      - name: âœ… Validate Deployment
        run: |
          echo "ðŸ” Validating Test deployment..."
          python scripts/validate_deployment.py \
            --workspace-id "${{ secrets.FABRIC_TEST_WORKSPACE_ID }}" \
            --environment test
          echo "âœ… Deployment validation passed"
      
      - name: ðŸ“Š Generate Deployment Report
        if: always()
        run: |
          echo "## ðŸš€ Deployment to Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workspace | \`${{ env.FABRIC_WORKSPACE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Reason | ${{ github.event.inputs.deployment_reason || 'Tag-triggered deployment' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notebooks | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipelines | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ¨ Test deployment completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')**" >> $GITHUB_STEP_SUMMARY
