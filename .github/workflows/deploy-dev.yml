name: Deploy to Fabric Dev

on:
  push:
    branches:
      - main
    paths:
      - 'notebooks/**'
      - 'pipelines/**'
      - 'config/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        type: boolean
        default: false

env:
  FABRIC_WORKSPACE_NAME: 'NVR-Dev1'
  ENVIRONMENT: 'dev'

jobs:
  deploy:
    name: Deploy to Dev Workspace
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better diffing
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests azure-identity pyyaml pandas jupyter nbformat
          echo "‚úÖ Dependencies installed"
      
      - name: üîê Authenticate to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: üé´ Get Fabric Access Token
        id: get_token
        run: |
          TOKEN=$(az account get-access-token --resource https://analysis.windows.net/powerbi/api --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "FABRIC_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "‚úÖ Fabric token acquired"
      
      - name: üìã Detect changed files
        id: changed_files
        run: |
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "Force deployment requested"
            echo "notebooks_changed=true" >> $GITHUB_OUTPUT
            echo "pipelines_changed=true" >> $GITHUB_OUTPUT
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            echo "$CHANGED_FILES"
            
            if echo "$CHANGED_FILES" | grep -q "^notebooks/"; then
              echo "notebooks_changed=true" >> $GITHUB_OUTPUT
            else
              echo "notebooks_changed=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$CHANGED_FILES" | grep -q "^pipelines/"; then
              echo "pipelines_changed=true" >> $GITHUB_OUTPUT
            else
              echo "pipelines_changed=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: üöÄ Deploy Notebooks to Fabric
        if: steps.changed_files.outputs.notebooks_changed == 'true'
        run: |
          echo "üöÄ Deploying notebooks to Fabric Dev workspace..."
          python scripts/deploy_to_fabric.py \
            --workspace-id "${{ secrets.FABRIC_DEV_WORKSPACE_ID }}" \
            --environment dev \
            --artifact-type notebooks \
            --artifacts-path notebooks/
          echo "‚úÖ Notebooks deployed successfully"
      
      - name: üîÑ Deploy Pipelines to Fabric
        if: steps.changed_files.outputs.pipelines_changed == 'true'
        run: |
          echo "üîÑ Deploying pipelines to Fabric Dev workspace..."
          python scripts/deploy_to_fabric.py \
            --workspace-id "${{ secrets.FABRIC_DEV_WORKSPACE_ID }}" \
            --environment dev \
            --artifact-type pipelines \
            --artifacts-path pipelines/
          echo "‚úÖ Pipelines deployed successfully"
      
      - name: ‚úÖ Validate Deployment
        run: |
          echo "üîç Validating deployment..."
          python scripts/validate_deployment.py \
            --workspace-id "${{ secrets.FABRIC_DEV_WORKSPACE_ID }}" \
            --environment dev
          echo "‚úÖ Deployment validation passed"
      
      - name: üìä Generate Deployment Report
        if: always()
        run: |
          echo "## üöÄ Deployment to Dev Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workspace | \`${{ env.FABRIC_WORKSPACE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Notebooks Deployed | ${{ steps.changed_files.outputs.notebooks_changed == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipelines Deployed | ${{ steps.changed_files.outputs.pipelines_changed == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**‚ú® Deployment completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')**" >> $GITHUB_STEP_SUMMARY
      
      - name: üì¢ Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Dev Deployment Failed',
              body: `Deployment to Dev workspace failed.\n\n**Workflow:** ${context.workflow}\n**Run:** ${context.runNumber}\n**Commit:** ${context.sha}\n\nPlease check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`,
              labels: ['deployment', 'bug']
            })
